#!/bin/bash
# rt-stats: generate statistics of your RequestTracker 
# Copyright: (C) 2011 Florian Baumann <flo@noqqe.de>
# License: GPL-3 <http://www.gnu.org/licenses/gpl-3.0.txt>
# Date: Tuesday 2011-04-12

### Include configuration
if [ -e conf/rt-stats.conf ]; then
    source conf/rt-stats.conf
    if [ -e conf/rt-stats.local ]; then
        source conf/rt-stats.local
    fi
else
    echo "Error: Could not find config file conf/rt-stats.conf"
    exit 1
fi

# The global sqlopts string is the way to connect to your database.
# Usually you don't have to touch this. 
# To keep this the last line before you start using modules is very important!
stats_sqlopts="--host=$stats_dbhost --port $stats_dbport --user=$stats_dbuser --password=$stats_dbpassword --batch"

# Single module mode and help message
if  [ $# -ne 0 ]; then
    case $1 in 
        -m) 
            # Use module
            if [ -r $2 ]; then
                source $2
                # Error in module
                if [ $? -gt 0 ]; then
                    echo "ERROR: Errors in module $2"
                fi
            else
                # Not found
                echo "ERROR: Could not find or read module: $2"
            fi
            exit 0
            ;;

        --help|-h|*) 
            # Help message
            echo "Usage: "
            echo " $0 "
            echo " $0 [-m module]"
            echo " $0 [--help]"
            ;;
    esac
fi 

### Load modules
echo "RequestTracker-Stats $(date +%B) $(date +%Y)"
echo "==================================================="
echo 

echo "Resolved tickets statistic"
echo "---------------------------------------------------"
echo "For this month ($(date +%B))"
source modules/resolved-tickets/resolved-month.bash
echo

echo "For last month ($(date --date="last month" +%B))"
source modules/resolved-tickets/resolved-last-month.bash 
echo 

echo "For this year ($(date +%Y))"
source modules/resolved-tickets/resolved-year.bash 
echo 

echo "Ticket status"
echo "---------------------------------------------------"
echo "For this month ($(date +%B))"
source modules/status/status-month.bash
echo 

echo "For this year ($(date +%Y))"
source modules/status/status-year.bash
echo 

echo "Queues" 
echo "---------------------------------------------------"
echo "For this month ($(date +%B))"
source modules/queues/queue-month.bash
echo 

echo "For last month ($(date --date="last month" +%B))"
source modules/queues/queue-last-month.bash
echo 

echo "For this year ($(date +%Y))"
source modules/queues/queue-year.bash
echo 

echo "Most active creators"
echo "---------------------------------------------------"
echo "For this month ($(date +%B))"
source modules/ticket-creators/creators-month.bash 
echo 

echo "For this year ($(date +%Y))"
echo "---------------------------------------------------"
source modules/ticket-creators/creators-year.bash 
echo 

echo "Ticket creation rate per Month ($(date +%Y))"
echo "---------------------------------------------------"
source modules/ticket-rate.bash 
echo 

echo "Monthly activity by user ($(date +%Y))"
echo "---------------------------------------------------"
source modules/user-activity.bash 
echo 

### Trailing informations 

echo "---------------------------------------------------"
echo "This stats were generated by RequestTracker-Stats"
echo "http://github.com/noqqe/RequestTracker-Stats"
echo
